<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoGen SoM Feedback</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        #chat-container { max-width: 800px; margin: auto; background: #fff; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #messages { height: 600px; overflow-y: scroll; border-bottom: 1px solid #ddd; padding: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px; border-radius: 8px; border: 1px solid #ddd; max-width: 80%; }
        .message .source { font-weight: bold; margin-bottom: 5px; }
        .message .content { white-space: pre-wrap; word-wrap: break-word; }
        .System { background-color: #f0e6ff; border-color: #d6b4ff; align-self: center; text-align: center; font-style: italic;}
        .error { background-color: #ffe6e6; border-color: #ffb4b4; }
        .You { background-color: #e6f7ff; border-color: #b4e0ff; align-self: flex-end; }
        .Writer { background-color: #e6fff2; border-color: #b4ffd9; align-self: flex-start; }
        .Editor { background-color: #fffbe6; border-color: #fff1b4; align-self: flex-start; }
        .Reviewer { background-color: #f6f6f6; border-color: #e0e0e0; align-self: flex-start; }
        .Human_ContentOverseer, .Human_ProjectOverseer, .ContentTeam_SoM, .QualityTeam_SoM { display: none; }
        #input-area { display: flex; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px 0 0 5px; }
        #send-button { padding: 10px 20px; border: none; background: #007bff; color: white; cursor: pointer; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="message-input" placeholder="Enter your task...">
            <button id="send-button">Send</button>
        </div>
    </div>
    <script>
        const ws = new WebSocket("ws://localhost:8000/ws/chat");
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        let lastUserMessage = "";

        function addMessage(source, content) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', source.replace(/ /g, '_'));

            const sourceElement = document.createElement('div');
            sourceElement.classList.add('source');
            sourceElement.textContent = source;
            
            const contentElement = document.createElement('div');
            contentElement.classList.add('content');
            contentElement.textContent = content;
            
            messageElement.appendChild(sourceElement);
            messageElement.appendChild(contentElement);
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'human_input_request') {
                setTimeout(() => {
                    addMessage('System', data.content);
                    messageInput.placeholder = "Your response...";
                }, 500);
            } else if (data.type === 'message') {
                // Do not display the user's own message again
                if (data.source !== 'Human_ContentOverseer' && data.source !== 'Human_ProjectOverseer') {
                    addMessage(data.source, data.content);
                }
            } else if (data.type === 'error') {
                addMessage('Error', data.content);
            }
        };

        function sendMessage() {
            const message = messageInput.value;
            if (message) {
                addMessage('You', message); // Display user's message immediately
                ws.send(JSON.stringify({ content: message }));
                messageInput.value = '';
                messageInput.placeholder = "Waiting for agent response...";
            }
        }

        sendButton.onclick = sendMessage;
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
